# ============================================================================
# Reset.yml - Fixed Database Reset Workflow
# ============================================================================

name: Initialize Database

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Database initialization action'
        required: true
        default: 'init-and-seed'
        type: choice
        options:
          - init-only
          - init-and-seed
          - seed-only
          - check-status
          - drop-and-recreate
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  initialize-database:
    name: Initialize Database
    runs-on: ubuntu-latest
    
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install PostgreSQL driver
        working-directory: LiquidSuite
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary
      
      - name: Install dependencies
        working-directory: LiquidSuite
        run: |
          pip install -r requirements.txt
      
      - name: Verify psycopg2 installation
        run: |
          python -c "import psycopg2; print(f'âœ… psycopg2 version: {psycopg2.__version__}')"
      
      # âœ… FIX: Convert postgres:// to postgresql:// for SQLAlchemy 2.x
      - name: Fix database URL format
        id: fix_db_url
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Convert postgres:// to postgresql://
          FIXED_URL="${DATABASE_URL//postgres:\/\//postgresql:\/\/}"
          echo "FIXED_DATABASE_URL=$FIXED_URL" >> $GITHUB_ENV
          echo "âœ… Database URL format fixed for SQLAlchemy 2.x"
      
      - name: Test database connection
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          import psycopg2
          from urllib.parse import urlparse
          
          db_url = os.getenv('DATABASE_URL')
          if not db_url:
              print("âŒ DATABASE_URL not set!")
              exit(1)
          
          # Verify it uses postgresql://
          if not db_url.startswith('postgresql://'):
              print(f"âš ï¸  URL should start with postgresql://, got: {db_url.split('://')[0]}://")
              if db_url.startswith('postgres://'):
                  print("Converting postgres:// to postgresql://...")
                  db_url = db_url.replace('postgres://', 'postgresql://', 1)
          
          parsed = urlparse(db_url)
          
          try:
              conn = psycopg2.connect(
                  host=parsed.hostname,
                  port=parsed.port or 5432,
                  user=parsed.username,
                  password=parsed.password,
                  database=parsed.path[1:]
              )
              print("âœ… Database connection successful!")
              
              cursor = conn.cursor()
              cursor.execute("SELECT version();")
              version = cursor.fetchone()[0]
              print(f"PostgreSQL version: {version}")
              
              cursor.close()
              conn.close()
              
          except Exception as e:
              print(f"âŒ Connection failed: {e}")
              exit(1)
          PYTHON
      
      - name: Drop all tables (if drop-and-recreate)
        if: github.event.inputs.action == 'drop-and-recreate'
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ—‘ï¸  Dropping all tables..."
          echo ""
          
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text
          
          db_url = os.getenv('DATABASE_URL')
          print(f"Using database URL: {db_url.split('@')[0]}@...")
          
          engine = create_engine(db_url)
          
          with engine.connect() as conn:
              trans = conn.begin()
              try:
                  # Drop all tables in cascade mode
                  result = conn.execute(text("""
                      SELECT tablename 
                      FROM pg_tables 
                      WHERE schemaname = 'public'
                  """))
                  
                  tables = [row[0] for row in result]
                  print(f"Found {len(tables)} tables to drop")
                  
                  for table in tables:
                      print(f"  Dropping {table}...")
                      conn.execute(text(f'DROP TABLE IF EXISTS "{table}" CASCADE'))
                  
                  trans.commit()
                  print("\nâœ… All tables dropped!")
                  
              except Exception as e:
                  trans.rollback()
                  print(f"âŒ Error: {e}")
                  raise
          PYTHON
      
      - name: Check and fix schema issues
        if: github.event.inputs.action != 'drop-and-recreate' && github.event.inputs.action != 'check-status'
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "ðŸ” Checking current schema..."
          echo "============================="
          echo ""
          
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text, inspect
          
          engine = create_engine(os.getenv('DATABASE_URL'))
          
          with engine.connect() as conn:
              trans = conn.begin()
              try:
                  inspector = inspect(engine)
                  tables = inspector.get_table_names()
                  
                  if 'bank_transactions' not in tables:
                      print("â„¹ï¸  bank_transactions table doesn't exist yet")
                      trans.commit()
                      exit(0)
                  
                  result = conn.execute(text("""
                      SELECT column_name, data_type
                      FROM information_schema.columns 
                      WHERE table_name = 'bank_transactions' 
                      AND column_name IN ('category', 'category_id', 'debits', 'credits', 
                                          'deposit', 'withdrawal', 'date', 'transaction_date')
                      ORDER BY column_name
                  """))
                  
                  columns = {row[0]: row[1] for row in result}
                  print("Current columns:")
                  for col, dtype in columns.items():
                      print(f"  - {col}: {dtype}")
                  
                  needs_migration = False
                  
                  if 'category' in columns and 'category_id' not in columns:
                      print("\nâš ï¸  Fixing: category â†’ category_id")
                      needs_migration = True
                  
                  if 'debits' in columns or 'credits' in columns:
                      if 'deposit' not in columns or 'withdrawal' not in columns:
                          print("\nâš ï¸  Fixing: debits/credits â†’ withdrawal/deposit")
                          needs_migration = True
                  
                  if 'transaction_date' in columns and 'date' not in columns:
                      print("\nâš ï¸  Fixing: transaction_date â†’ date")
                      needs_migration = True
                  
                  if needs_migration:
                      print("\nðŸ”§ Applying fixes...")
                      
                      if 'category' in columns:
                          conn.execute(text("ALTER TABLE bank_transactions DROP COLUMN category CASCADE"))
                          conn.execute(text("ALTER TABLE bank_transactions ADD COLUMN category_id INTEGER"))
                          conn.execute(text("""
                              ALTER TABLE bank_transactions 
                              ADD CONSTRAINT fk_bank_transactions_category_id 
                              FOREIGN KEY (category_id) REFERENCES transaction_categories(id) 
                              ON DELETE SET NULL
                          """))
                      
                      if 'debits' in columns and 'deposit' not in columns:
                          conn.execute(text("ALTER TABLE bank_transactions RENAME COLUMN debits TO withdrawal"))
                          conn.execute(text("ALTER TABLE bank_transactions RENAME COLUMN credits TO deposit"))
                      
                      if 'transaction_date' in columns and 'date' not in columns:
                          conn.execute(text("ALTER TABLE bank_transactions RENAME COLUMN transaction_date TO date"))
                      
                      trans.commit()
                      print("\nâœ… Schema fixed!")
                  else:
                      trans.commit()
                      print("\nâœ… Schema correct!")
                  
              except Exception as e:
                  trans.rollback()
                  print(f"\nâŒ Error: {e}")
                  raise
          PYTHON
      
      - name: Initialize Database Tables
        if: |
          github.event.inputs.action == 'init-only' || 
          github.event.inputs.action == 'init-and-seed' ||
          github.event.inputs.action == 'drop-and-recreate'
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo ""
          echo "ðŸ“Š Creating database tables..."
          echo ""
          python scripts/init_db.py init
          echo ""
          echo "âœ… Database initialization complete!"
      
      - name: Seed Transaction Categories
        if: |
          github.event.inputs.action == 'seed-only' || 
          github.event.inputs.action == 'init-and-seed' ||
          github.event.inputs.action == 'drop-and-recreate'
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo ""
          echo "ðŸŒ± Seeding transaction categories..."
          echo ""
          python scripts/seed_categories.py seed
          echo ""
          echo "âœ… Categories seeded!"
      
      - name: Check Database Status
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo ""
          echo "ðŸ” Verifying database..."
          echo ""
          python scripts/init_db.py check
      
      - name: Verify schema
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          echo ""
          echo "âœ… Final verification..."
          echo ""
          
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, inspect
          
          engine = create_engine(os.getenv('DATABASE_URL'))
          inspector = inspect(engine)
          
          columns = {col['name']: col['type'] for col in inspector.get_columns('bank_transactions')}
          
          expected = ['date', 'posting_date', 'description', 'deposit', 'withdrawal', 
                      'balance', 'category_id', 'reference_number']
          
          print("Required columns:")
          missing = []
          for col in expected:
              if col in columns:
                  print(f"  âœ… {col}")
              else:
                  print(f"  âŒ {col} - MISSING!")
                  missing.append(col)
          
          if missing:
              print(f"\nâš ï¸  Missing: {', '.join(missing)}")
          else:
              print("\nâœ… All columns present!")
          PYTHON
      
      - name: List Categories
        if: |
          github.event.inputs.action == 'seed-only' || 
          github.event.inputs.action == 'init-and-seed' ||
          github.event.inputs.action == 'drop-and-recreate'
        working-directory: LiquidSuite
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
          SQLALCHEMY_DATABASE_URI: ${{ env.FIXED_DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo ""
          echo "ðŸ“‹ Categories:"
          echo ""
          python scripts/seed_categories.py list
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "âœ… SUCCESS!"
          echo "=========="
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          
          case "${{ github.event.inputs.action }}" in
            init-only)
              echo "âœ… Tables created"
              ;;
            init-and-seed)
              echo "âœ… Database ready!"
              ;;
            drop-and-recreate)
              echo "âœ… Fresh database!"
              ;;
          esac
