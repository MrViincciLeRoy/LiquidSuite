# ============================================================================
# .github/workflows/fix-erpnext-name-column.yml
# Fix ALL missing columns in erpnext_configs table
# ============================================================================
name: Fix ERPNext Config Columns

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  fix-erpnext-column:
    name: Fix erpnext_configs Table
    runs-on: ubuntu-latest
    
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install psycopg2-binary sqlalchemy
      
      - name: Fix Database URL Format
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Convert postgres:// to postgresql://
          FIXED_URL="${DATABASE_URL//postgres:\/\//postgresql:\/\/}"
          echo "FIXED_DATABASE_URL=$FIXED_URL" >> $GITHUB_ENV
          echo "‚úÖ Database URL format fixed for SQLAlchemy 2.x"
      
      - name: Test Database Connection
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          import psycopg2
          from urllib.parse import urlparse
          
          print("=" * 70)
          print("  TESTING DATABASE CONNECTION")
          print("=" * 70)
          
          db_url = os.getenv('DATABASE_URL')
          if not db_url:
              print("‚ùå DATABASE_URL not set!")
              exit(1)
          
          parsed = urlparse(db_url)
          
          try:
              conn = psycopg2.connect(
                  host=parsed.hostname,
                  port=parsed.port or 5432,
                  user=parsed.username,
                  password=parsed.password,
                  database=parsed.path[1:]
              )
              print("‚úÖ Database connection successful!")
              
              cursor = conn.cursor()
              cursor.execute("SELECT version();")
              version = cursor.fetchone()[0]
              print(f"PostgreSQL version: {version[:50]}...")
              
              cursor.close()
              conn.close()
              
          except Exception as e:
              print(f"‚ùå Connection failed: {e}")
              exit(1)
          PYTHON
      
      - name: Check Current Schema
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text, inspect
          
          print("\n" + "=" * 70)
          print("  CHECKING CURRENT SCHEMA")
          print("=" * 70)
          
          db_url = os.getenv('DATABASE_URL')
          engine = create_engine(db_url)
          
          with engine.connect() as conn:
              inspector = inspect(engine)
              tables = inspector.get_table_names()
              
              if 'erpnext_configs' not in tables:
                  print("\n‚ùå erpnext_configs table doesn't exist!")
                  print("   Please run the init database workflow first")
                  exit(1)
              
              print("\n‚úÖ erpnext_configs table exists")
              
              # Get all columns
              columns = inspector.get_columns('erpnext_configs')
              
              print("\nüìã Current columns in erpnext_configs:")
              for col in sorted(columns, key=lambda x: x['name']):
                  print(f"  - {col['name']:<30} {str(col['type']):<20}")
          PYTHON
      
      - name: Add ALL Missing Columns
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text, inspect
          
          print("\n" + "=" * 70)
          print("  ADDING ALL MISSING COLUMNS")
          print("=" * 70)
          
          db_url = os.getenv('DATABASE_URL')
          engine = create_engine(db_url)
          
          # Define all required columns from the model
          required_columns = {
              'name': 'VARCHAR(100) NOT NULL DEFAULT \'Default ERPNext\'',
              'base_url': 'VARCHAR(255) NOT NULL DEFAULT \'https://example.erpnext.com\'',
              'default_company': 'VARCHAR(200)',
              'bank_account': 'VARCHAR(200)',
              'default_cost_center': 'VARCHAR(200)',
          }
          
          with engine.connect() as conn:
              inspector = inspect(engine)
              existing_columns = [col['name'] for col in inspector.get_columns('erpnext_configs')]
              
              print(f"\nüìã Existing columns: {len(existing_columns)}")
              print(f"üìã Required columns: {len(required_columns)}")
              
              missing_columns = {k: v for k, v in required_columns.items() if k not in existing_columns}
              
              if not missing_columns:
                  print("\n‚úÖ All columns already exist!")
                  exit(0)
              
              print(f"\n‚ö†Ô∏è  Missing {len(missing_columns)} columns:")
              for col in missing_columns:
                  print(f"  - {col}")
              
              trans = conn.begin()
              
              try:
                  # Add all missing columns
                  for col_name, col_type in missing_columns.items():
                      print(f"\nüîß Adding {col_name}...")
                      conn.execute(text(f"""
                          ALTER TABLE erpnext_configs 
                          ADD COLUMN IF NOT EXISTS {col_name} {col_type}
                      """))
                      print(f"   ‚úÖ {col_name} added")
                  
                  # Update existing rows with better names if name column was added
                  if 'name' in missing_columns:
                      print("\nüîß Updating existing row names...")
                      result = conn.execute(text("""
                          UPDATE erpnext_configs 
                          SET name = 'ERPNext Config ' || id::text 
                          WHERE name = 'Default ERPNext'
                      """))
                      
                      rows_updated = result.rowcount
                      if rows_updated > 0:
                          print(f"   ‚úÖ Updated {rows_updated} existing rows")
                  
                  # Update base_url for existing rows if it was added
                  if 'base_url' in missing_columns:
                      print("\nüîß Setting base_url for existing rows...")
                      result = conn.execute(text("""
                          UPDATE erpnext_configs 
                          SET base_url = 'https://your-erpnext-instance.com'
                          WHERE base_url = 'https://example.erpnext.com'
                      """))
                      if result.rowcount > 0:
                          print(f"   ‚úÖ Updated {result.rowcount} rows (you'll need to update with real URL)")
                  
                  trans.commit()
                  
                  print("\n" + "=" * 70)
                  print("‚úÖ ALL COLUMNS ADDED SUCCESSFULLY!")
                  print("=" * 70)
                  
              except Exception as e:
                  trans.rollback()
                  print(f"\n‚ùå ERROR: {e}")
                  import traceback
                  traceback.print_exc()
                  exit(1)
          PYTHON
      
      - name: Verify Fix
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text, inspect
          
          print("\n" + "=" * 70)
          print("  VERIFYING FIX")
          print("=" * 70)
          
          db_url = os.getenv('DATABASE_URL')
          engine = create_engine(db_url)
          
          with engine.connect() as conn:
              inspector = inspect(engine)
              
              # Check columns
              columns = {col['name']: col for col in inspector.get_columns('erpnext_configs')}
              
              # List of required columns from the model
              required = [
                  'id', 'user_id', 'name', 'base_url', 'api_key', 
                  'api_secret', 'default_company', 'bank_account', 
                  'default_cost_center', 'is_active', 'last_sync',
                  'created_at', 'updated_at'
              ]
              
              print("\n‚úÖ Verification checks:")
              
              missing = []
              for col in required:
                  if col in columns:
                      print(f"  ‚úÖ {col:<30} {str(columns[col]['type']):<20}")
                  else:
                      print(f"  ‚ùå {col:<30} MISSING!")
                      missing.append(col)
              
              if missing:
                  print(f"\n‚ùå Still missing: {', '.join(missing)}")
                  exit(1)
              
              # Test the actual query that was failing
              print("\nüß™ Testing the query that caused the 500 error...")
              try:
                  result = conn.execute(text("""
                      SELECT id, user_id, name, base_url, api_key, api_secret, 
                             default_company, bank_account, default_cost_center, 
                             is_active, last_sync, created_at, updated_at 
                      FROM erpnext_configs 
                      WHERE is_active = true 
                      LIMIT 1
                  """))
                  print("  ‚úÖ Query executed successfully!")
                  
                  row = result.fetchone()
                  if row:
                      print(f"     Config found: ID {row[0]}, Name: {row[2]}")
                      print(f"     Base URL: {row[3]}")
                  else:
                      print("     ‚ÑπÔ∏è  No active configs yet (table empty)")
              except Exception as e:
                  print(f"  ‚ùå Query failed: {e}")
                  exit(1)
              
              print("\n" + "=" * 70)
              print("‚úÖ ALL CHECKS PASSED!")
              print("=" * 70)
          PYTHON
      
      - name: Show Current Configs
        env:
          DATABASE_URL: ${{ env.FIXED_DATABASE_URL }}
        run: |
          python << 'PYTHON'
          import os
          from sqlalchemy import create_engine, text
          
          print("\n" + "=" * 70)
          print("  CURRENT ERPNEXT CONFIGURATIONS")
          print("=" * 70)
          
          db_url = os.getenv('DATABASE_URL')
          engine = create_engine(db_url)
          
          with engine.connect() as conn:
              result = conn.execute(text("""
                  SELECT id, user_id, name, base_url, is_active 
                  FROM erpnext_configs 
                  ORDER BY id
              """))
              
              configs = result.fetchall()
              
              if not configs:
                  print("\n‚ÑπÔ∏è  No ERPNext configurations found")
                  print("   You can add one through the web interface")
              else:
                  print(f"\nüìã Found {len(configs)} configuration(s):\n")
                  for cfg in configs:
                      status = "üü¢ ACTIVE" if cfg[4] else "‚ö™ INACTIVE"
                      print(f"  {status}")
                      print(f"    ID:       {cfg[0]}")
                      print(f"    User ID:  {cfg[1]}")
                      print(f"    Name:     {cfg[2]}")
                      print(f"    Base URL: {cfg[3]}")
                      print()
          PYTHON
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "========================================================================"
          echo "‚úÖ FIX COMPLETED SUCCESSFULLY!"
          echo "========================================================================"
          echo ""
          echo "Changes applied:"
          echo "  ‚úÖ Added 'name' column"
          echo "  ‚úÖ Added 'base_url' column"
          echo "  ‚úÖ Added 'default_company' column"
          echo "  ‚úÖ Added 'bank_account' column"
          echo "  ‚úÖ Added 'default_cost_center' column"
          echo "  ‚úÖ Updated existing rows with default values"
          echo "  ‚úÖ Verified all required columns exist"
          echo ""
          echo "Your application should now work correctly!"
          echo "The 500 error on /bridge/bulk-operations is fixed."
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT NEXT STEPS:"
          echo "  1. Go to your ERPNext settings page in the app"
          echo "  2. Update the base_url with your actual ERPNext URL"
          echo "  3. Update other configuration fields as needed"
          echo ""
          echo "All bulk operations features should now work!"
          echo ""
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo ""
          echo "‚ùå FIX FAILED"
          echo "========================================================================"
          echo ""
          echo "The migration encountered an error."
          echo "Please check the logs above for details."
          echo ""
          echo "Common issues:"
          echo "  - DATABASE_URL secret not set correctly"
          echo "  - Database connection failed"
          echo "  - erpnext_configs table doesn't exist yet"
          echo ""
          echo "Solutions:"
          echo "  1. Run 'Initialize Database' workflow first"
          echo "  2. Check your DATABASE_URL secret"
          echo "  3. Try running this workflow again"
          echo ""
